<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>MovieHunter</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script src="../js/jquery-1.4.2.min.js"></script>
    <script src="../js/jquery-func.js"></script>
    <link href="../css/style.css" rel="stylesheet" />
    <link href="../css/ie6.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
            crossorigin="anonymous">
    </script>
    <link href="../Content/myCSS.css" rel="stylesheet" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <script src="../Scripts/ajaxCalls.js"></script>
    <link href="../css/scrollCard.css" rel="stylesheet" />
    <!-- firebase -->
    <script src="https://www.gstatic.com/firebasejs/7.14.6/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.6/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.6/firebase-database.js"></script>
    <script src="../js/firebase.js"></script>
    <link href="../css/commentsCss.css" rel="stylesheet" />

    <script>
        $(document).ready(function () {
            key = "1c107f2bd2f3fc2aee24aa4f2f8d8647";
            url = "https://api.themoviedb.org/";
            imagePath = "https://image.tmdb.org/t/p/w500/";
            renderHome(); //rendering basic home layout
            $("#registerForm").submit(register);
            $("#getTV").submit(getTV);
            if (localStorage.getItem("user") != null) { //checking if user is logged in
                loginRender();
            }
        });

        //--------------------------------------//
        //rendering home page section//
        //--------------------------------------//
        function renderHome() {
            //POPULAR AJAX
            let apiUrl = url + `3/tv/popular?api_key=${key}&language=en-US&page=1`
            ajaxCall("GET", apiUrl, "", getrenderPopularSuccessCB, getrenderPopularErrorCB); 
            //TOP RATED AJAX
            apiUrl = url + `3/tv/top_rated?api_key=${key}&language=en-US&page=1`
            ajaxCall("GET", apiUrl, "", getTopRatedSuccessCB, getTopRatedErrorCB); 
            //TOP RATED AJAX
            apiUrl = url + `3/tv/airing_today?api_key=${key}&language=en-US&page=1`
            ajaxCall("GET", apiUrl, "", getAiringTodaySuccessCB, getAiringTodayErrorCB); 
        }

        //--------------------------------------//
        //MOST POPULAR render section//
        //--------------------------------------//
        function getrenderPopularSuccessCB(trailers) {
            let str = `</br><h2>MOST POPULAR</h2><div class="container-fluid"><div class="scrolling-wrapper row flex-row flex-nowrap mt-4 pb-4 pt-2">`;;
            for (let i = 0; i < 6; i++) {
                str += `<div class="col-3"><div class="card card-block" onclick="getTVHomepage(${trailers.results[i].id} , '${imagePath + trailers.results[i].poster_path}')" value = "${trailers.results[i].id}"  style="background-image:url('${imagePath + trailers.results[i].poster_path}');background-size: contain;background-repeat: no-repeat;"><h4 style='bottom:0;-webkit-text-stroke: 1px black;left:30%;position: absolute;'>${trailers.results[i].name}</h4></div></div>`;
            }
                str += `</div></div>`;
           
            $("#content").append(str);
        }
        function getrenderPopularErrorCB(err) {
            console.log(err);
        }

        //--------------------------------------//
        //TOP RATED render section//
        //--------------------------------------//
        function getTopRatedSuccessCB(top) {
            let str = `<br><h2>TOP RATED</h2><div class="container-fluid"><div class="scrolling-wrapper row flex-row flex-nowrap mt-4 pb-4 pt-2">`;;
            for (let i = 0; i < 6; i++) {

                str += `<div class="col-3"><div class="card card-block " onclick="getTVHomepage(${top.results[i].id} , '${imagePath + top.results[i].poster_path}')" value = "${top.results[i].id}" style="background-image:url('${imagePath + top.results[i].poster_path}');background-size: contain;background-repeat: no-repeat;"><h4 style='bottom:0;-webkit-text-stroke: 1px black;left:30%;position: absolute;'>${top.results[i].name}</h4></div></div>`;
            }
            str += `</div></div>`;
            $("#content").append(str);
        }
        function getTopRatedErrorCB(err) {
            console.log(err);

        }

        //--------------------------------------//
        //Airing render section//
        //--------------------------------------//
        function getAiringTodaySuccessCB(airing) {
            let str = `<br><h2>AIRING TODAY</h2><div class="container-fluid"><div class="scrolling-wrapper row flex-row flex-nowrap mt-4 pb-4 pt-2">`;;
            for (let i = 0; i < 6; i++) {

                str += `<div class="col-3"><div class="card card-block " onclick="getTVHomepage(${airing.results[i].id} , '${imagePath + airing.results[i].poster_path}')"value = "${airing.results[i].id}" style="background-image:url('${imagePath + airing.results[i].poster_path}');background-size: contain;background-repeat: no-repeat;"><h4 style='bottom:0;-webkit-text-stroke: 1px black;left:30%;position: absolute;'>${airing.results[i].name}</h4></div></div>`;
            }
            str += `</div></div>`;
            $("#content").append(str);
        }
        function getAiringTodayErrorCB(err) {
            console.log(err);

        }

        //--------------------------------------//
        //login section//
        //--------------------------------------//
        function login() {
            let user = $("#username").val();
            let pass = $("#password").val();
            apiCall = '../api/User?user=' + user + "&pass=" + pass;
            ajaxCall("GET", apiCall, "", loginSuccessCB, loginErrorCB);
            return false;
        }
        function loginSuccessCB(user) {
            delete user.Password;
            localStorage.user = JSON.stringify(user);
            loginRender();
        }
        function loginErrorCB(err) {
            console.log(err);
        }
        function loginRender() {
            if (JSON.parse(localStorage.getItem('user')).IsAdmin) { //checking if user is admin to show admin panel.
                $("#adminPanelBtn").css("display", "block");
            }
            $('#myModal').modal('hide');
            $("#loginBtn").css("display", "none");
            $("#registerBtn").css("display", "none");
            $("#logoutBtn").css("display", "block");
            $("#viewBtn").css("display", "block");
            $("#user").html("Hello " + JSON.parse(localStorage.getItem('user')).Name);
        }
                //--------------------------------------//
        //logout section//
        //--------------------------------------//
        function logout() {
            localStorage.clear();
            $('#logoutBtn').css("display", "none");
            $("#loginBtn").css("display", "block");
            $("#registerBtn").css("display", "block");
            $("#viewBtn").css("display", "none");
            $("#adminPanelBtn").css("display", "none");
            $("#commentSection").css("display", "none");
            $("#user").html("");
        }

        //--------------------------------------//
        //register section//
        //--------------------------------------//
        function register() {
            let user = {
                Name: $("#RName").val(),
                LastName: $("#RLast").val(),
                Mail: $("#RMail").val(),
                Password: $("#RPass").val(),
                PhoneNum: $("#RPhone").val(),
                Sex: $("#RGender").val(),
                YearOfBirth: $("#RBirth").val(),
                FavGenre: $("#RGenre").val(),
                Address: $("#RAddress").val(),
            };
            apiCall = '../api/User';
            ajaxCall("POST", apiCall, JSON.stringify(user), registerSuccessCB, registerErrorCB)
            return false;
        }
        function registerSuccessCB() {
            alert("Thank you for registering!");
            $('#myModalRegister').modal('hide');
        }
        function registerErrorCB(err) {
            console.log(err);
        }

        //--------------------------------------//
        //searching tv names section//
        //--------------------------------------//
        function getTV() {
            let name = $("#search-field").val();
            let method = "3/search/tv?";
            let api_key = "api_key=" + key;
            let moreParams = "&language=en-US&page=1&include_adult=false&";
            let query = "query=" + encodeURIComponent(name);
            let apiCall = url + method + api_key + moreParams + query;
            ajaxCall("GET", apiCall, "", gettvSuccessCB, getTVErrorCB);
            return false;
        }
        function getTVErrorCB(err) {
            console.log(err);
        }

        //--------------------------------------//
        //Renders search results.//
        ////--------------------------------------//
        function gettvSuccessCB(tv) {
            tvGlobal = tv;
            $("#main").html("");
            $("#main").append(`<div class="container">
            <hgroup class="mb20">
                <h2>Search Results</h2>
                <h2 class="lead"><strong class="text-danger">${tv.results.length}</strong> 
                results were found for the search for <strong class="text-danger">${$("#search-field").val()}</strong></h2>
            </hgroup>`);
            for (let i = 0; i < tv.results.length; i++) {
                if (tvGlobal.results[i].poster_path == null) {
                    str = "../css/images/image-not-found.jpg";
                }
                else {
                    str = imagePath + tv.results[i].poster_path
                }
                $("#main").append(`<article onclick="renderSeries(${i})" class="search-result row border rounded" >
                <div class="col-xs-12 col-sm-12 col-md-3">
                    <a href="#"  class="thumbnail"><img style="max-height:195px;max-width:140px;height:195px;width:140px;" src="${str}"  /></a>
                </div>
                <div class="col-xs-12 col-sm-12 col-md-2">
                    <ul class="meta-search">
                        <i class="fa fa-calendar"></i> <span>${tv.results[i].first_air_date}</span><br/>
                        <i class="fa fa-star"></i> <span>${tv.results[i].vote_average}/10.0</span>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-12 col-md-7 excerpet">
                    <h2>${tv.results[i].name}</h2>
                    <p style="color:white;">${tv.results[i].overview}</p>
                </div>
                <span class="clearfix borda"></span>

            </article><br/>`);

            }
            $('#main').append('</section>');
            $('#main').append('</div>');
        }

        //--------------------------------------//
        //creating divs for series data, renders poster, then does ajaxcalls to get more info.//
        ////--------------------------------------//
        function renderSeries(i) {
            seriesIndexGlobal = i;
            let poster = imagePath + tvGlobal.results[i].poster_path;
            let str = "<img style='max-height:400px;max-width:400px;margin-left: auto;  margin-right: auto;display: block;' src='" + poster + "'/>";
            $("#main").html(`<div id="poster">
                            </div>
                            <div id="seasonsData" style="color:white;">
                            </div><br/>
                            <div id="episodesofSeason" style="color:white;"></div>`);
            $("#seasonsData").html("");
            $("#poster").html(str);
            let method = "3/tv/";
            let api_key = "api_key=" + key;
            tvIdGlobal = tvGlobal.results[i].id;
            let apiCall = url + method + tvIdGlobal + "?" + api_key;
            ajaxCall("GET", apiCall, "", getSeasonSuccessCB, getSeasonErrorCB);
        }

        //--------------------------------------//
        //Rendering series data to the cards and calls getSeriesActors method to render actors , getVideo method to render video
        //and the init function to render the comment section for specific series.
        //--------------------------------------//
        function getSeasonSuccessCB(season) {
            tvIdGlobal = season.id;
            seasonGlobal = season;
            if (JSON.parse(localStorage.getItem('user')) != null) {
                $("#commentSection").css("display", "block");
            }
            let str = '';
            str += `<div class="container-fluid"><div class="scrolling-wrapper row flex-row flex-nowrap mt-4 pb-4 pt-2">`;
            for (let i = 0; i < season.seasons.length; i++) {

                str += `<div class="col-3"><div class="card card-block " value = "${season.seasons[i].season_number}" onClick="renderSeason(this)"style="-webkit-text-stroke: 1px black;background-image:url('${imagePath + season.seasons[i].poster_path}');background-size: contain;background-repeat: no-repeat;"><h4 style='bottom:0;left:20%;-webkit-text-stroke: 1px black;position: absolute;'>${season.seasons[i].name}</h4></div></div>`;
            }
            str += `</div></div>`;
            $("#seasonsData").append(str);
            getSeriesActors();
            getVideo();
            init();

        }
        function getSeasonErrorCB(err) {
            console.log(err);
        }

        //--------------------------------------//
        //gets the video link from the movieDB.//
        ////--------------------------------------//
        function getVideo() {
           
            let str = `3/tv/${seasonGlobal.id}/videos?api_key=${key}`;
            ajaxCall("GET", url + str, "", getVideoSuccessCB, getVideoErrorCB);
        }

        function getVideoSuccessCB(videos) {
            let str='';
            if (videos.results.length > 0) {
                str += "https://www.youtube.com/embed/" + videos.results[0].key;
                $("#seasonsData").append(`<h2>Trailer:</h2><br/>`);
                $("#seasonsData").append(`<iframe width="999px" height="450px" text-align:center; src=${str}></iframe >`);
            }
        }
        function getVideoErrorCB(err) {
            console.log(err);
        }

        //--------------------------------------//
        //gets the series actors from the movieDB.//
        ////--------------------------------------//
        function getSeriesActors() {
            let method = "3/tv/";
            let api_key = "api_key=" + key;
            let apiCall = url + method + tvIdGlobal + '/credits' + "?" + api_key;
            ajaxCall("GET", apiCall, "", getSeriesActorsSuccessCB, getSeriesActorsErrorCB);
        }
        function getSeriesActorsSuccessCB(actors) {
            actorsGlobal = actors;
            let str = '';
            str += `<div class="container-fluid"><div class="scrolling-wrapper row flex-row flex-nowrap mt-4 pb-4 pt-2">`;
            for (let i = 0; i < actors.cast.length; i++) {

                str += `<div class="col-3"><div class="card card-block " value = "${i}" onClick="addActor(this)"style="background-image:url('${imagePath + actors.cast[i].profile_path}');background-size: contain;background-repeat: no-repeat;"><h4 style='-webkit-text-stroke: 1px black;bottom:0;left:20%;position: absolute;'>${actors.cast[i].name}</h4></div></div>`;
            }
            str += `</div></div>`;
            $("#seasonsData").append(str);
        }
        function getSeriesActorsErrorCB(err) {
            console.log(err)
        }

        //--------------------------------------//
        //adds the clicked actor to the favorite actors list for logged in user.//
        ////--------------------------------------//
        function addActor(i) {
            if (localStorage.getItem('user') != null) {
                i = parseInt(i.getAttribute("value"));
                let actor = {
                    id: actorsGlobal.cast[i].id,
                    gender: actorsGlobal.cast[i].gender,
                    name: actorsGlobal.cast[i].name,
                    popularity: actorsGlobal.cast[i].popularity,
                    picture: imagePath + actorsGlobal.cast[i].profile_path
                }
                let apiCall = "../api/Actor?id=" + JSON.parse(localStorage.getItem('user')).Id;
                ajaxCall("POST", apiCall, JSON.stringify(actor), addActorSuccessCB, addActorErrorCB);
            }
        }
        function addActorSuccessCB(num) {
            if (num == 0) {
                alert("Actor added already!");
            }
            else {
                alert("Actor added successfully!");

            }
        }

        function addActorErrorCB(err) {
            console.log(err);
        }
        //--------------------------------------//
        //Gets selected season.//
        //--------------------------------------//
        function renderSeason(sNum) {
            sNum = parseInt(sNum.getAttribute("value"));
            let api_key = "api_key=" + key;
            let method = "3/tv/";
            let moreParams = "&language=en-US";
            let apiCall = url + method + tvIdGlobal + '/season/' + (sNum) + '?' + api_key + moreParams;
            ajaxCall("GET", apiCall, "", getEpisodeSuccessCB, getEpisodeErrorCB)
            return false;
        }
        //--------------------------------------//
        //renders episodes of the selected season.//
        //--------------------------------------//
        function getEpisodeSuccessCB(episode) {
            let str = '';
            $('#episodesofSeason').html(str);
            episodeGlobal = episode;
            for (let i = 0; i < episode.episodes.length; i++) {
                str += `<article onclick="addEpisode(${i})" class="search-result row border rounded" >
                <div class="col-xs-12 col-sm-12 col-md-3">
                    <a href="#"  class="thumbnail"><img style="max-height:100%;max-width:100%;" src="${imagePath + episode.episodes[i].still_path}"  /></a>
                </div>
                <div class="col-xs-12 col-sm-12 col-md-2">
                    <ul class="meta-search">
                        <i class="fa fa-calendar"></i> <span>${episode.episodes[i].air_date}</span><br/>
                        <i class="fa fa-star"></i> <span>${episode.episodes[i].vote_average}/10.0</span>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-12 col-md-7 excerpet">
                    <h2 style="-webkit-text-stroke: 1px black;">${episode.episodes[i].name}</h2>
                    <p style="color:white;">${episode.episodes[i].overview}</p>
                </div>
                <span class="clearfix borda"></span>

            </article><br/>`

            }
            $('#episodesofSeason').append(str);

        }

        function getEpisodeErrorCB(err) {
            console.log(err);
        }
        //--------------------------------------//
        //merge functions for adding series and episodes.//
        //--------------------------------------//
        function addEpisode(sNum) {
            if (localStorage.getItem('user') != null) {
                addSeries();
                addEpisodetoDB(sNum);
            }
        }

        //--------------------------------------//
        //adds series to db// POST
        //--------------------------------------//
        function addSeries() {
            let series = {
                Id: tvGlobal.results[seriesIndexGlobal].id,
                First_air_date: tvGlobal.results[seriesIndexGlobal].first_air_date,
                Name: (tvGlobal.results[seriesIndexGlobal].name).split("?").join(''),
                Origin_country: tvGlobal.results[seriesIndexGlobal].origin_country[seriesIndexGlobal],
                Original_language: tvGlobal.results[seriesIndexGlobal].original_language,
                Overview: (tvGlobal.results[seriesIndexGlobal].overview).split("'").join(''),
                Popularity: tvGlobal.results[seriesIndexGlobal].popularity,
                Poster_path: imagePath + tvGlobal.results[seriesIndexGlobal].poster_path,
            }
            console.log(series);
            apiCall = '../api/Series';
            ajaxCall("POST", apiCall, JSON.stringify(series), postSeriesSuccessCB, postSeriesErrorCB);
            return false;
        }
        function postSeriesSuccessCB() {

        }
        function postSeriesErrorCB() {

        }
        //--------------------------------------//
        //adds episode to the db// POST
        //--------------------------------------//
        function addEpisodetoDB(sNum) {
            let episode = {
                Id: episodeGlobal.episodes[sNum].id,
                seriesId: seasonGlobal.id,
                Name: seasonGlobal.name,
                NameOfEp: (episodeGlobal.episodes[sNum].name).split("'").join(''),
                Picture: imagePath + episodeGlobal.episodes[sNum].still_path,
                Description: (episodeGlobal.episodes[sNum].overview).split("'").join(''),
                NumOfSeason: episodeGlobal.episodes[sNum].season_number,
                Date: episodeGlobal.episodes[sNum].air_date,
            }
            apiCall = '../api/Episodes?id=' + JSON.parse(localStorage.getItem('user')).Id;
            ajaxCall("POST", apiCall, JSON.stringify(episode), addEpisodeSuccessCB, addEpisodeErrorCB);
            return false;
        }

        function addEpisodeSuccessCB(i) {
            if (i == 0)
                alert('episode added already!!');
            else
                alert('Added Successfully!');
        }
        function addEpisodeErrorCB(err) {
            console.log(err);
        }

        //--------------------------------------//
        //GetTV function for the shows on homepage when clicking.
        //--------------------------------------//
        function getTVHomepage(id, poster) {
            $("#content").html("");
            let str = "<img style='max-height:400px;max-width:400px;margin-left: auto;  margin-right: auto;display: block;' src='" + poster + "'/>";
            $("#main").html(`<div id="poster">
                            </div>
                            <div id="seasonsData" style="color:white;">
                            </div><br/>
                            <div id="episodesofSeason" style="color:white;"></div>`);
            $("#seasonsData").html("");
            $("#poster").html(str);
            let apiUrl = url + `3/tv/${id}?api_key=${key}&language=en-US`;
            ajaxCall("GET", apiUrl, "", getSeasonSuccessCB, getTVHomepageErrorCB); 
        }
        function getTVHomepageErrorCB(err) {
            console.log(err);
        }

        //--------------------------------------//
        //initialises comments for series page.
        //--------------------------------------//
        function init() {
            $("#comments").html("");
            commentArr = []; //all the data of the comments in each series
            replyDictionary = {};
            ref = firebase.database().ref(seasonGlobal.name);
            ref = firebase.database().ref(seasonGlobal.name.split("/").join("").split(".").join("") + '/' + 'comment');
            reply = firebase.database().ref(seasonGlobal.name + '/' + 'comment' + '/' + 'reply');
            listenToNewMessages();
            listenToNewReply();
            
            // listen to removing messages
        }

        //--------------------------------------//
        //this function looks by key if msg is already exist in our messeges 
        //--------------------------------------//
        function addTocommentArr(msg) {
             const found = commentArr.find((innermsg) => {
                 return innermsg.key === msg.key
            })
            if (!found) {
                commentArr.push(msg);
                
            }
        }
        //--------------------------------------//
        //this function checks if there is a reply for a comment, if not it initialises reply dictionary for comment by his parent.
        //--------------------------------------//
        function addToReplayArr(msg) {
            if (this.replyDictionary[msg.parent]) {
                const found = replyDictionary[msg.parent].find((innermsg) => {
                    return innermsg.key === msg.key
                })
                if (!found) {
                    replyDictionary[msg.parent].push(msg);
                }
            }

        }

        //--------------------------------------//
        //this function is for adding the comments by pressing the button.
        //--------------------------------------//
        function addComment() {
            var today = new Date();
            var date = today.getFullYear() + '-' + (today.getMonth() + 1) + '-' + today.getDate();
            var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
            dateTime = date + ' ' + time;
            let msg = document.getElementById("msgTB").value;
            let name = JSON.parse(localStorage.getItem('user')).Name;
            let like = 0;
            ref.push().set({ "msg": msg, "name": name, "date": dateTime, "likes": like,});
        }

       
        //--------------------------------------//
        //this function is for rendering the data and give for each value in the array the rendering div
        //--------------------------------------//
        function printComment() {
            clearUiList("comments"); //delete all the childes of the element
            const commentsElement = this.commentArr.map((msg) => {
                return `<div class="comment mt-4 text-justify float-left" style="max-width:100%;" >
                        <img src="https://i.imgur.com/yTFUilP.jpg" alt="" class="rounded-circle" width="40" height="40" />
                        <h4>${msg.name}</h4> <span>${msg.date}</span> <br />
                        <p>${msg.content}</p>
                        <button id="comment:${msg.key}" onclick="likeComment('${msg.key}');" class="btn btn-block btn-primary" style="width:70px;height:50px;"><i class="fa fa-thumbs-up">${msg.likes}</i> </button>
                        <div id="${msg.key}"></div>
                        <div class="text-justify darker mt-4 float-right"  style="display:inline-block;max-width:100%;">
                        <input type="text" id="A${msg.key}" class='btn btn-dark'></input>
                        <button class='btn btn-dark' onclick='addReplay("${msg.key}")'>Add replay</button>
                        <div>
                        </div>`;
                 
                
            });
            $("#comments").append(commentsElement);
            printReplay();
        }

        //--------------------------------------//
        //this function is to add a like to the comment.
        //--------------------------------------//
        function likeComment(key) {
            firebase.database().ref(seasonGlobal.name + "/comment/" + key + "/likes").set(firebase.database.ServerValue.increment(1));
            document.getElementById("comment:" + key).textContent = (parseInt(document.getElementById("comment:" + key).textContent) + 1);
        }

        //--------------------------------------//
        //this function is to add a like to the reply.
        //--------------------------------------//
        function likeReply(key) {
            firebase.database().ref(seasonGlobal.name + "/comment/reply/" + key + "/likes").set(firebase.database.ServerValue.increment(1));
            document.getElementById("comment:" + key).textContent = (parseInt(document.getElementById("comment:" + key).textContent) + 1);
        }

        //--------------------------------------//
        //this function prints replies for the selected series.
        //--------------------------------------//
        function printReplay() {
            const replyKeys = Object.keys(this.replyDictionary); // take the object and return arr of all of the keys
            replyKeys.forEach((commentId) => {
                if (this.replyDictionary[commentId]) {
                    const element = this.replyDictionary[commentId].map((msg) => {
                        console.log(msg);
                        return `<div class="text-justify darker mt-4 float-right"><img src="https://i.imgur.com/yTFUilP.jpg" class="rounded-circle"  width="40" height="40"/>
                    <h4>${msg.name}</h4> <span>${msg.date}</span><br />
                    <p id="replyP" style="max-width:70%;">${msg.content}</p></div>`;

                    });
                    clearUiList(commentId);
                    $("#" + commentId).append(element);
                }
            });
        }

        //--------------------------------------//
        //clears UI for comment section.
        //--------------------------------------//
        function clearUiList(id) {
            let listElement = $("#" + id)[0];
            while (listElement.firstChild) {
                listElement.removeChild(listElement.firstChild);
            }
        }
        //--------------------------------------//
        //this function adds a new reply
        //--------------------------------------//
        function addReplay(msg) {
            let comments = document.getElementById("A" + msg).value;
            var today = new Date();
            var date = today.getFullYear() + '-' + (today.getMonth() + 1) + '-' + today.getDate();
            var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
            dateTime = date + ' ' + time;
            let like = 0;
            let name = JSON.parse(localStorage.getItem('user')).Name;
            const replyObj = { "msg": comments, "name": name, "date": dateTime, "parent": msg,};
            reply.push().set(replyObj);
        }

        //--------------------------------------//
        //listen to each comment that enter and adding key for each comment for finding it and prevent doubles
        //--------------------------------------//
        function listenToNewMessages() {
            ref.on("child_added", (snapshot) => {
                data = snapshot.val();
                if (snapshot.key != "reply") {  //if this is not the last reply 
                    msg = {
                        name: data.name,
                        content: data.msg,
                        date: data.date,
                        key: snapshot.key,
                        likes: data.likes,
                    }
                    
                    addTocommentArr(msg);
                    if (this.replyDictionary[msg.key] == undefined) {
                        this.replyDictionary[msg.key] = [];
                    }
                }
                else {
                    mergeReplyData(data);
                }
                printComment();

                
            })
        
        }

        //--------------------------------------//
        //if the new message is a reply to an older message, then it gets handled here.
        //--------------------------------------//
        function mergeReplyData(data) {
            const keys = Object.keys(data);
            keys.forEach((key) => {
                const reply = data[key];
                this.addToReplayArr({
                    name: reply.name,
                    content: reply.msg,
                    date: reply.date,
                    key,
                    parent: reply.parent,
                });
                return key;
            });
        }

        //--------------------------------------//
        //listen to each reply that enter and adding key for each reply for finding it and prevent doubles
        //--------------------------------------//
        function listenToNewReply() {

            reply.on("child_added", (snapshot) => {
                data = snapshot.val();
             
                if (data.name) {
                    msg = {
                        name: data.name,
                        content: data.msg,
                        date: data.date,
                        key: snapshot.key,
                        parent: data.parent,
                    }
                    addToReplayArr(msg);
                    printReplay();
                    
                }
            })

        }
        
      

    </script>
</head>
<body>

    <!-- START PAGE SOURCE -->
    <div id="shell">
        <div id="header">
            <h1 id="logo"><a href="index1.html">MovieHunter</a></h1>

            <div id="navigation">
                <ul>
                    <li><a class="active" href="#" onclick="window.location.reload()">HOME</a></li>
                    <li><a href="#myModal" data-toggle="modal" id="loginBtn">LOGIN</a></li>
                    <li><a href="#myModalRegister" data-toggle="modal" id="registerBtn">REGISTER</a></li>
                    <li> <a onclick="logout()" id="logoutBtn" style="display:none;">Log Out</a></li>
                    <li><a href="view.html" id="viewBtn" style="display:none;">View Favorites</a></li>
                    <li><a href="adminPanel.html" id="adminPanelBtn" style="display:none;">Admin Panel</a></li>

                </ul>
                <ul>
                    <li id="user"></li>
                </ul>

            </div>

            <!-- Modal HTML  LOGIN-->
            <div id="myModal" class="modal fade">
                <div class="modal-dialog modal-login">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title">Member Login</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form>
                                <div class="form-group">
                                    <i class="fa fa-envelope-o"></i>
                                    <input id="username" type="text" class="form-control" placeholder="Username" required="required" />
                                </div>
                                <div class="form-group">
                                    <i class="fa fa-lock"></i>
                                    <input id="password" type="password" class="form-control" placeholder="Password" required="required" />
                                </div>
                                <div class="form-group">
                                    <input type="button" onclick="login();" class="btn btn-primary btn-block btn-lg" value="Login" />
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Modal HTML  REGISTER-->
            <div id="myModalRegister" class="modal fade">
                <div class="modal-dialog modal-login">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title">Member Registeration</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="registerForm">
                                <div class="form-group">
                                    <i class="fa fa-envelope-o"></i>
                                    <input pattern="[A-Za-z0-9._%+-]+@[a-z0-9.-]+.[a-z]{2,}$" type="text" id="RMail" class="form-control" placeholder="Mail" required="required" />
                                </div>
                                <div class="form-group">
                                    <i class="fa fa-lock"></i>
                                    <input pattern="(?=.*\d)(?=.*[A-Z]).{6,}" type="password" id="RPass" oninvalid="this.setCustomValidity('Invalid format! atleast 1 Uppercase 1 number and  6 letters required!')"
                                           oninput="this.setCustomValidity('')" class="form-control" placeholder="Password" required="required" />
                                </div>
                                <div class="form-group">
                                    <i class="fa fa-user"></i>
                                    <input type="text" id="RName" class="form-control" placeholder="Name" required="required" />
                                </div>
                                <div class="form-group">
                                    <i class="fa fa-user"></i>
                                    <input type="text" id="RLast" class="form-control" placeholder="Last Name" required="required" />
                                </div>
                                <div class="form-group">
                                    <i class="fa fa-phone"></i>
                                    <input pattern="0[\d]{2}-[\d]{7}" type="text" id="RPhone" class="form-control" placeholder="Phone Number" oninvalid="setCustomValidity('Invalid format! Required Format 0dd-ddddddd')" oninput="this.setCustomValidity('')" required="required" />
                                </div>
                                <div class="form-group">
                                    <i class="fa fa-venus-double"></i>
                                    <select id="RGender" class="form-control" required="required">
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <i class="fa fa-birthday-cake"></i>
                                    <input pattern="^[12][0-9]{3}$" id="RBirth" class="form-control" placeholder="Year of Birth" required="required" />
                                </div>
                                <div class="form-group">
                                    <i class="fa fa-film"></i>
                                    <select id="RGenre" name="cars" class="form-control">
                                        <option value="Action">Action</option>
                                        <option value="Comedy">Comedy</option>
                                        <option value="Adventure">Adventure</option>
                                        <option value="Drama">Drama</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <i class="fa fa-home"></i>
                                    <input type="text" id="RAddress" class="form-control" placeholder="Address" required="required" />
                                </div>
                                <div class="form-group">
                                    <input id="submitbtn" type="submit" class="btn btn-primary btn-block btn-lg" value="Submit" />

                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sub-navigation">
               
                <div id="search">
                    <form action="#" method="get" accept-charset="utf-8" id="getTV">
                        <label for="search-field">SEARCH</label>
                        <input type="text" name="search field" id="search-field" class="blink search-field" />
                        <input type="submit" class="btn btn-dark" value="Submit" />

                    </form>
                </div>

            </div>
        </div>
        <div id="main">
            <div id="poster">
            </div>
            <div id="seasonsData" style="color:white;">
            </div>
            <div id="content">
            </div>
        </div>

    </div>

    <!-- Main Body -->
    <section  id="commentSection" style="display:none">
        <div class="container">
            <h2 style="text-align:center">Comments</h2><br />
            <div class="row">
                <div class="col-sm-5 col-md-6 col-12 pb-4" id="comments" style="width: 600px; height: 200px; overflow-y: scroll;direction: rtl;">

                </div>
                <div class="col-lg-4 col-md-5 col-sm-4 offset-md-1 offset-sm-1 col-12 mt-4">
                    <form id="algin-form">
                        <div class="form-group">
                            <h4>Leave a comment</h4> <label for="message">Message</label> <textarea name="msg" id="msgTB" msg=msg cols="30" rows="5" class="form-control" style="background-color: black;"></textarea>
                        </div>
                        <div class="form-group"> <button type="button" onclick="addComment()" id="post" class="btn">Post Comment</button> </div>
                    </form>
                </div>
            </div>
        </div>
    </section>
    <!-- END PAGE SOURCE -->
</body>
</html>